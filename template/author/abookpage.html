{% extends 'author/abase.html' %}

{% block body %}
  <body class="bg-orange-50 text-amber-950">
    <div class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-md flex flex-col md:flex-row gap-6">
      <!-- Left: Book Cover + Name + Description + Buttons -->
      <div class="flex-shrink-0 w-full md:w-1/3 flex flex-col items-center gap-3">
        <!-- Book Cover -->
        <img src="{% if book.coverimage %}
            {{ book.coverimage.url }}
          {% else %}
            
            
            
            https://via.placeholder.com/180x270/FBBF24/FFFFFF?text=No+Cover



          {% endif %}"
          alt="{{ book.bname }} Cover"
          class="w-56 md:w-64 aspect-[2/3] object-cover rounded shadow-md" />

        <!-- Book Name -->
        <h2 class="text-amber-950 text-lg font-bold text-center">{{ book.bname }}</h2>

        <!-- Scrollable Description -->
        <div class="w-full max-h-64 overflow-y-auto p-3 bg-gray-100 rounded text-sm text-gray-800">{{ book.description }}</div>

        <!-- Edit & Delete Buttons -->
        <div class="flex gap-3 w-full">
          <a href="#" class="flex-1 text-center bg-amber-500 text-white font-semibold px-3 py-1.5 rounded hover:bg-amber-600 transition">Edit Book</a>
          <button id="deleteBookBtn" class="flex-1 bg-red-500 text-white font-semibold px-3 py-1.5 rounded hover:bg-red-600 transition">Delete Book</button>
        </div>
      </div>

      <!-- Right: Chapter Management -->
      <div class="w-full md:w-2/3 flex flex-col gap-4">
        <!-- Header with Add Chapter Button -->
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Chapters</h2>
          <a href="{% url 'addchapter' book.id %}" class="bg-amber-500 text-white font-semibold px-3 py-1.5 rounded hover:bg-amber-600 transition">Add Chapter</a>
        </div>

        <!-- Chapters List -->
        <div class="flex flex-col gap-2 overflow-y-auto max-h-[400px]">
          {% for chapter in chapters %}
            <div class="flex justify-between items-center p-3 bg-gray-100 rounded shadow hover:bg-gray-200 transition">
              <span class="w-8 font-medium">{{ chapter.order }}.</span>
              <span class="flex-1 px-2 truncate">{{ chapter.title }}</span>
              <div class="flex gap-2">
                <a href="{% url 'edit_chapter' chapter.id %}" class="bg-amber-900 text-white text-xs px-2.5 py-1.5 rounded hover:bg-amber-800 transition">Edit</a>
                <button data-url="{% url 'delete_chapter' chapter.id %}" class="delete-chapter-btn bg-orange-500 text-white text-xs px-2.5 py-1.5 rounded hover:bg-orange-600 transition">Delete</button>
              </div>
            </div>
          {% empty %}
            <p class="text-gray-600 text-center p-4">No chapters found for this book.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div id="deleteChapterModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-xl p-6 w-80 max-w-sm shadow-lg text-center">
        <h3 class="text-lg font-bold mb-4">Confirm Delete</h3>
        <p class="mb-6 text-sm text-gray-700">Are you sure you want to delete this chapter?</p>
        <div class="flex justify-center gap-4">
          <button id="confirmDeleteChapter" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">Yes</button>
          <button id="cancelDeleteChapter" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">No</button>
        </div>
      </div>
    </div>

    <div id="deleteBookConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-xl p-6 w-80 max-w-sm shadow-lg text-center">
        <h3 class="text-lg font-bold mb-3">Confirm Book Deletion</h3>
        <p class="text-sm text-gray-700 mb-4">
          Type the book name (<strong>{{ book.bname }}</strong>) to confirm deletion:
        </p>
        <input type="text" id="confirmBookNameInput" placeholder="Enter book name" class="w-full p-2 mb-4 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" />
        <div class="flex justify-center gap-3">
          <button id="confirmDeleteBookBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">Delete Book</button>
          <button id="cancelDeleteBookBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      const deleteBookBtn = document.getElementById('deleteBookBtn')
      const deleteBookConfirmModal = document.getElementById('deleteBookConfirmModal')
      const confirmDeleteBookInput = document.getElementById('confirmBookNameInput')
      const confirmDeleteBookActionBtn = document.getElementById('confirmDeleteBookBtn')
      const cancelDeleteBookActionBtn = document.getElementById('cancelDeleteBookBtn')
      
      const deleteBookUrl = "{% url 'delete_book' book.id %}"
      const bookName = '{{ book.bname|escapejs }}'
      
      deleteBookBtn.addEventListener('click', () => {
        deleteBookConfirmModal.classList.remove('hidden')
        confirmDeleteBookInput.value = ''
        confirmDeleteBookInput.focus()
      })
      
      cancelDeleteBookActionBtn.addEventListener('click', () => {
        deleteBookConfirmModal.classList.add('hidden')
      })
      
      confirmDeleteBookActionBtn.addEventListener('click', () => {
        const typedName = confirmDeleteBookInput.value.trim().toLowerCase()
        const correctName = bookName.trim().toLowerCase()
      
        if (typedName === correctName) {
          window.location.href = deleteBookUrl
        } else {
          alert(`Book name does not match! Please type '${bookName}' to confirm.`)
          confirmDeleteBookInput.focus()
        }
      })
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !deleteBookConfirmModal.classList.contains('hidden')) {
          cancelDeleteBookActionBtn.click()
        }
      })
    </script>
  </body>
{% endblock %}
